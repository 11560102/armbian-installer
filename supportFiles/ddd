#!/bin/bash

show_menu() {
    clear
    echo "====================================="
    echo "  Armbian x86-UEFI Installer by wukongdaily"
    echo "====================================="
    echo "1. Install Armbian x86-UEFI"
    echo "0. Quit"
    echo "====================================="
}

detect_disk() {
    # 获取所有可用磁盘信息（GB单位）
    local disk_info=()
    while IFS= read -r line; do
        name=$(cut -d' ' -f1 <<< "$line")
        size=$(cut -d' ' -f4 <<< "$line")
        size_gb=$(awk "BEGIN {printf \"%.2f\", $size/1000000000}")
        disk_info+=("$name" "${size_gb}GB")
    done < <(lsblk -d -n -b -o NAME,SIZE,RO,TYPE | awk '$3 == "0" && $4 == "disk" {print $1, $2}')

    # 显示带容量和类型的磁盘菜单
    echo -e "\n可用磁盘列表："
    for ((i=0; i<${#disk_info[@]}; i+=2)); do
        printf "%2d. %-12s %-8s\n" $((i/2+1)) "${disk_info[i]}" "${disk_info[i+1]}"
    done

    # 用户选择逻辑
    while true; do
        read -p "请选择目标磁盘编号 (1-$((${#disk_info[@]}/2))): " choice
        if [[ $choice =~ ^[0-9]+$ ]] && ((choice >=1 && choice <= ${#disk_info[@]}/2)); then
            selected_disk="${disk_info[2*(choice-1)]}"
            echo "[安全提示] 即将操作磁盘: $selected_disk"
            echo "$selected_disk"
            return
        else
            echo "输入错误，请输入有效编号"
        fi
    done
}

confirm_danger() {
    local target_disk=$1
    local image_file=$2
    
    echo "!! DANGEROUS OPERATION CONFIRMATION !!"
    echo "──────────────────────────────────────"
    echo "Target device: $target_disk"
    echo "Image file:    $image_file"
    echo "──────────────────────────────────────"
    echo "This will ERASE ALL DATA on $target_disk!"
    read -p "Confirm write operation? (Type uppercase YES to proceed): " confirm

    if [ "$confirm" != "YES" ]; then
        echo "Operation cancelled"
        exit 0
    fi

     # 清除所有分区表和签名
    echo "正在清除磁盘残留数据..."
    sudo sgdisk --zap-all "$target_disk" 2>/dev/null
    sudo wipefs -a "$target_disk" 2>/dev/null
    sudo partprobe "$target_disk"  # 强制内核刷新分区表
}

install_system() {
    local image_name=$1
    local image_file="/mnt/$image_name"
    local target_disk
    
    # 获取用户选择的硬盘
    target_disk=$(detect_disk)
    
    # 显示磁盘信息
    echo -e "\nDisk Information:"
    fdisk -l "$target_disk" | grep Disk | head -1
    
    # 检查镜像文件是否存在
    if [ ! -f "$image_file" ]; then
        echo -e "\nError: Image file $image_file not found!"
        echo "Please:"
        echo "1. Place the image file in /mnt directory"
        echo "2. Verify file permissions"
        exit 1
    fi
    
    # 二次确认
    confirm_danger "$target_disk" "$image_file"
    
    echo -e "\nStarting system write... (Press Ctrl+C to cancel)"
    sleep 2
    
    # 执行写入操作
    dd if="$image_file" of="$target_disk" bs=4M conv=fsync status=progress
    
    echo "──────────────────────────────────────"
    echo "Write completed! Recommended actions:"
    echo "1. Disconnect system disk"
    echo "2. Reboot device"
    echo "3. Configure via web interface (router IP)"
}

while true; do
    show_menu
    read -p "Enter your choice [0-1]: " choice
    
    case $choice in
        1)
            install_system "armbian.img"
            break
            ;;
        0)
            echo "Exiting installer"
            exit 0
            ;;
        *)
            echo "Invalid option, please try again"
            sleep 2
            ;;
    esac
done